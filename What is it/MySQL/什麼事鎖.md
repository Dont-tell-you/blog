# 什麼事鎖

## 什麼事鎖
    對要處理的共享資源或是程式區塊只允許一個程序執行，而鎖就是資料庫區別於文件系統的一個重要特性，
    資料庫是要處理資料 (共享資源) 的狀態變更，所以在同筆資料是會有並發處理的場景狀況，而用鎖的機制來解決並發的場景，
    這樣資料庫才可提供對資料處理的正確性。

### 什麼事悲觀鎖和樂觀鎖
    悲觀鎖與樂觀鎖並不是只一個實際程式的鎖的意思，在這指的是抽象角度的方式去理解它，而這兩種鎖指的就是程式對於鎖不同的設計思維方式。

    悲觀鎖：對於資料在並發的場景下，總是假設會有很大機率發生同筆資料有兩個人要修改的，所以在修改資料前一定要先上鎖保證同時間只有一個人修改資料，
           此方法以悲觀的思維看待資料修改。

    樂觀鎖：對於資料在並發的場景下，樂觀的認為不會同筆資料同時間有兩個人要修改，所以在資料修改前不需做上鎖的動作，
           但會在修改資料的時候做驗證機制，來確保資料沒有被其他人修改過後才可成功修改資料，此驗證機制會用版本號或時間戳等方式實作。

### mysql 鎖的粒度
    指的是上鎖的範圍或是大小，分為表鎖和行鎖。

    表鎖：指的是上鎖為一張表，鎖的粒度大、實現容易和加鎖速度快，但因為上鎖的範圍是一張表容易發生鎖衝突，
         如果只是改一筆資料上表鎖，其他人則要修改另一筆資料則需等待，表鎖會降低並發的量，不會發生死鎖。
         總結特性為鎖的粒度大、開銷小、加鎖快、不會發生死鎖、鎖的衝突最高、並發最低。

    行鎖：指的是上鎖為一筆資料，但在 mysql 上鎖都是在索引上，在這行鎖指的是加鎖在索引上，如果 sql 語句沒有命中索引則會上鎖整張表，
         因行鎖粒度到一筆資料跟當其他人修改另一筆資料不會發生鎖衝突，行鎖的並發量比表鎖高很多，但因為要對 sql 語句內的資料上鎖，
         會大大增加鎖的開銷因每筆資料都需上鎖和加鎖速度慢，容易發生死鎖因多個 sql 語句是對每筆資料上鎖容易發生上鎖順序相反場景。
         總結特性為鎖的粒度小、開銷大、加鎖慢、容易發生死鎖、鎖的衝突低、並發最高。

    死鎖指的是當兩個以上 sql 語句要對資料上鎖時候需要互相等待對方的鎖，在這的等待有兩種情況，如果 sql 語句上鎖順序是一樣的，
    這時候等待鎖只會發生鎖超時等待的，而死鎖場景的等待是 sql 語句上鎖順序是相反方向上鎖，像是一扇門兩個人要同時穿越一個從左邊一個從右邊，
    當兩個人都卡住時候就陷入死循環無法執行稱為死鎖。

    死鎖跟鎖的粒度的關係，表鎖是上一個表的鎖所以只要上一把鎖，當有兩個 sql 語句要上鎖也只會是同順序的上鎖，只會發生鎖的超時等待情況，
    行鎖是要對多筆資料一個一個上鎖此時是多把鎖，這才會有可能發生順序相反的上鎖情況，所以表鎖不會有死鎖，只有行鎖才會有死鎖的問題。

### mysql 鎖的類型
    指的是加上什麼樣的鎖，如有讀鎖、寫鎖、讀意向鎖、寫意向鎖、AUTO_INC 鎖。

    讀鎖：是對資料上一把讀鎖，代表可以讀取資料但不能修改資料。

    寫鎖：是對資料上一把寫鎖，代表可以讀取和修改資料，但同時間只有一個人可以上寫鎖，而當上了寫鎖其他人不可以上讀鎖和寫鎖。

    意向鎖指的是一個表級別的鎖，因為表鎖和行鎖是有重疊的資料範圍當重疊到代表發生衝突，當事務要上行鎖前會先上一個意向鎖在去執行上行鎖，
    這樣要確認有沒有資料被上行鎖，只要檢驗表上的意向鎖就可以知道了。

    讀意向鎖：代表有資料上了讀鎖。
  
    寫意向鎖：代表有資料上了寫鎖。
  
    AUTO_INC 鎖：是一種特殊的表級鎖，用來處理表中欄位類型有 AUTO_INCREMENT 的資料，當資料庫要計算自增的數值時會用 AUTO_INC 上鎖，
                來確保新增值的唯一性，mysql 對此做了優化可以用 innodb_autoinc_lock_mode 設定不同的策略來提升效能。

    鎖的兼容與衝突關係：
    - 讀鎖可以和讀意向鎖、讀鎖兼容，跟其它鎖發生衝突。
    - 寫鎖不兼容其它鎖。
    - 意向鎖之間是兼容的，AI 鎖也和意向鎖兼容。
    - 寫意向鎖不兼容讀鎖，因為寫意向鎖代表有寫鎖發生。
    - AI 鎖只會跟意向鎖兼容，跟其它鎖發生衝突。

### mysql 行鎖的算法
    在行鎖可以再細分為紀錄鎖、間隙鎖、Next-key 鎖、插入意向鎖。

    紀錄鎖：上鎖索引紀錄，這邊指的索引是依照 sql 語句將相關索引紀錄上鎖，不管是主鍵索引、二級索引通通都會上鎖，
           如果沒有任何索引則會對 mysql 創建的隱形主鍵上鎖。
  
    間隙鎖：上鎖在兩個索引紀錄之間的間隙上，防止其它事務對這間隙做資料的操作如新增、修改等，如果是第一個索引或是最後的索引則會上鎖在索引與邊界的間隙，
           間隙鎖與間隙鎖之間是兼容的。
  
    Next-key 鎖：是用紀錄鎖加上間隙鎖組成的，可同時鎖住索引紀錄與間隙的功能。
  
    插入意向鎖：是一種特殊的間隙鎖，主要是表達有要新增資料的意向概念，插入意向鎖與插入意向鎖之間也是兼容的， 
              但插入意向鎖會跟間隙鎖和 Next-key 鎖衝突，所以只要 sql 語句上了間隙鎖或 Next-key 鎖就可以阻擋新增語句的插入意向鎖。

    鎖的兼容與衝突關係：
    - 紀錄鎖跟間隙鎖和插入意向鎖兼容，因為紀錄鎖不會影響間隙上的鎖，會跟紀錄鎖、Next-key 鎖衝突。
    - 間隙鎖跟紀錄鎖、間隙鎖、Next-key 鎖兼容，跟插入意向鎖衝突。
    - Next-key 鎖只跟間隙鎖兼容，跟紀錄鎖、Next-key 鎖、插入意向鎖會衝突。
    - 插入意向鎖跟插入意向鎖之間是兼容的，會跟間隙鎖和 Next-key 鎖衝突但不會跟紀錄鎖衝突。

### mysql 的 MVCC
    mvcc 是提供一種方式可以再做讀取時候不用加鎖也可以讀取到資料又稱為快照讀，另一種上鎖讀取資料方式稱為當前讀， 在 mysql 只有下 select 語句是走快照讀，
    而 select ... for update (上寫鎖方式讀取資料)、 select ... lock in share mode (上讀鎖方式讀取資料)，
    而 update、delete、insert 都會下一個當前讀的語句上鎖來取得最新的資料。

    mvcc 是將每次的資料修改操作時候都產生一個版本紀錄，在執行 select 語句時會在多個版本紀錄中選擇此事務可以看到的最新資料，
    這樣就可以不用去索引上加讀鎖方式取得資料，讓讀跟寫操作可以同時進行不會互相發生衝突。

## 鎖和事務的隔離級別關係
    隔離級別是要處理事務在並發下可看到資料的正確性的狀況，我們來舉例一個例子來了解情況，
      舉例 A 事務更新了金額 500 此時尚未提交狀態，B 事務如果可以看到 A 事務尚未提交的金額 500， 這樣的情況對於 B 事務來說資料是正確的嗎？
  
    隔離級別用鎖做到事務對於資料的可見性，當要對資料操作時候用鎖將資料加上讀鎖或寫鎖來確保資料的正確性，
    當隔離級別越高並發越低、資料越正確，當隔離級別越低並發越高、資料越不正確，
    隔離級別就是一個資料正確性與並發量的 trade off，每個隔離級別要解決不同資料正確性的問題「髒讀、不可重複讀、幻讀」。

### 什麼事髒讀
    當有兩個事務同時進行中，此時其中一個事務做查詢時可以查詢到另一個事務正在更新的資料結果並尚未做提交操作，
    因為尚未提交所以有可能發生事務做回滾就像是沒做過更新資料操作一樣，髒讀意思是事務可以讀取另一個事務正在對資料的更新操作但尚未做提交，
    未提交的資料稱為髒資料，能讀取髒資料就稱為髒讀。

### 鎖如何處理髒讀
    事務在做修改的操作如新增、更新、刪除時，對資料上持續的寫鎖當事務結束才釋放寫鎖，此時其它事務做查詢時需要上讀鎖，
    因寫鎖會阻擋讀鎖，所以事務會等待鎖狀態，就不會讀取到未提交的資料，在後續為了提升並發量 mysql 使用 mvcc 方案就變成，
    修改操作一樣持續上寫鎖，查詢資料就改為使用 mvcc 的版本紀錄內取得查詢結果資料。

### 什麼事不可重複讀
    指的是事務在進行中的第一次查詢結果跟第二次查詢結果不一樣，這邊指的查詢結果是同一筆資料的欄位值不一樣，明明是同樣的查詢語句重複執行兩次就不一樣，
    因為當解決髒讀後就都是讀取到提交後的資料，但當第一次查詢後另一個事務做了資料更新操作並已提交操作， 此時在做查詢操作一樣的查詢語句會讀取到新的資料結果。

### 鎖如何處理不可重複讀
    事務一樣做修改操作時是上持續的寫鎖，在讀取資料時是上持續的讀鎖，當事務結束時才釋放寫和讀鎖，而髒讀場景的讀鎖只是臨時的不會持續到事務結束，
    因髒讀只要解決讀的資料是已提交資料，而當讀鎖一直持續可以保證不會有其它事務修改資料因為寫鎖會組塞，這樣就可解決不可重複讀的問題，
    後續 mysql 使用 mvcc 方案，一樣查詢資料會在 mvcc 的版本紀錄內取得查詢結果資料，為了解決不可重複讀，在事務開始時就產生可視圖的資料，
    來確保此事務的可見範圍內的資料，不會因其它事務更新資料影響到原本事務的可見範圍內的資料，來解決不可重複讀的問題。

### 什麼事幻讀
    幻讀跟不可重複讀很相似也常常容易搞混，因為幻讀也是指事務再進行第一次查詢結果跟第二次查詢結果不一樣，但不一樣是多了一筆資料或是少了一筆資料，
    原本第一次查詢出三筆資料，此時其它事務做了新增或刪除的資料操作，在執行一樣的查詢語句會變成四筆資料或二筆資料，好像剛剛第一次查詢的那筆資料本來就不存在，
    幻讀指的是範圍查詢結果執行兩次不一樣的狀況，而不可重複讀是查詢結果的單筆資料執行兩次欄位值不一樣的狀況。

### 鎖如何處理幻讀
    如果是用行鎖的話是解決不了幻讀，因為幻讀發生場景是對資料做新增或刪除，刪除資料行鎖可以阻擋但新增資料行鎖事阻擋不了，
    所以傳統上需要上表鎖方式才可阻擋其它事務進行新增資料操作，但 mysql 是通過間隙鎖方式對行與行之間的間隙上鎖來阻擋其它事務的新增資料操作。

## 總結
    鎖是一個很重要的機制與通用知識點，在資料庫也需要使用鎖機制處理有狀態的資料，而在程式語言上也需要鎖機制同樣處理有狀態的資料或是有順序的執行，
    在處理並發場景下最容易的方式就是用上鎖與解鎖方式處理，而 mysql 就是悲觀鎖為核心設計的軟體，藉由了解 mysql 鎖機制的設計原理相信是會更加深鎖的理解與運用。

---
- 備註
  <br/>
  MVCC (Multiversion Concurrency Control) 中文翻譯為多版本並發控制。

- 參考
  <br/>
  [資料庫交易的 Isolation](https://medium.com/getamis/database-transaction-isolation-a1e448a7736e)
  <br/>
  [複習資料庫的 Isolation Level 與圖解五個常見的 Race Conditions](https://medium.com/@chester.yw.chu/%E8%A4%87%E7%BF%92%E8%B3%87%E6%96%99%E5%BA%AB%E7%9A%84-isolation-level-%E8%88%87%E5%B8%B8%E8%A6%8B%E7%9A%84%E4%BA%94%E5%80%8B-race-conditions-%E5%9C%96%E8%A7%A3-16e8d472a25c)
  <br/>
  [對於 MySQL Repeatable Read Isolation 常見的三個誤解](https://medium.com/@chester.yw.chu/%E5%B0%8D%E6%96%BC-mysql-repeatable-read-isolation-%E5%B8%B8%E8%A6%8B%E7%9A%84%E4%B8%89%E5%80%8B%E8%AA%A4%E8%A7%A3-7a9afbac65af)
  <br/>
  [浅谈数据库并发控制 - 锁和 MVCC](https://draveness.me/database-concurrency-control/)
  <br/>
  [MySQL锁系列（六）之 MVCC](https://keithlan.github.io/2017/06/16/innodb_locks_MVCC/)
  <br/>
  [MySQL探秘(六):InnoDB一致性非锁定读](https://zhuanlan.zhihu.com/p/66045800)
  <br/>
  [解决死锁之路 - 学习事务与隔离级别](https://www.aneasystone.com/archives/2017/10/solving-dead-locks-one.html)
  <br/>
  [解决死锁之路 - 了解常见的锁类型](https://www.aneasystone.com/archives/2017/11/solving-dead-locks-two.html)
  <br/>
  [解决死锁之路 - 常见 SQL 语句的加锁分析](https://www.aneasystone.com/archives/2017/12/solving-dead-locks-three.html)
  <br/>
  [Innodb中的事务隔离级别和锁的关系](https://tech.meituan.com/2014/08/20/innodb-lock.html)
  <br/>
  [MySQL InnoDB锁机制全面解析分享](https://segmentfault.com/a/1190000014133576)
  <br/>
  [年薪50万的DBA必须了解的MySQL锁和事务 ](https://www.sohu.com/a/325450808_411876)
  <br/>
  [MySQL的并发控制与加锁分析](https://www.cnblogs.com/yelbosh/p/5813865.html)
  <br/>
  [秒懂INNODB的鎖](https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/752836/)
  <br/>
  [MySQL锁总结](https://zhuanlan.zhihu.com/p/29150809)
  