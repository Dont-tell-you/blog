# 什麼事備份和恢復流程

## 什麼事備份
    對資料庫的數據做複製一份資料操作稱為備份，可以分為對資料庫的物理文件操作的物理備份，如數據文件或日志文件的複製，
    也有對資料庫的表對象複製的邏輯備份，備份是要避免資料遺失的情況，當有備份的資料就可以用來重新建立資料庫或用來恢復數據的動作。

### 什麼事冷備、熱備、溫備
    這三種備份的差異點是，備份執行時候影響資料庫運行的狀況。
    冷備是資料庫關閉時候做的備份，
        優點操作容易、執行時間快速，缺點備份期間資料庫無法提供功能。
    熱備是資料庫運行中時候，同時有做寫入資料操作運行情況下的備份，
        優點資料庫可提供功能不影響運行，缺點會跟寫入操作互相競爭，如果正在備份，需要等備份釋放鎖才可執行寫入操作。
    溫備是資料庫一樣運行中的時候，但此時不可做寫入資料操作，只可以做讀資料的操作的備份，
        優點資料庫一樣可提供功能不影響運行，但只提供讀的操作，缺點無法提供寫入操作的功能，此備份是介於冷備與熱備的折中方案。

### 什麼事全量備份、增量備份
    這兩種備份的差異點是，備份的數據的範圍。
    全量備份是完整對資料庫的檔案備份，
        優點是操作簡單、備份資料完整性高，缺點是備份時間過久，會跟數據成正比關係。
    增量備份是建立在上次全量備份到現在有異動過的檔案的才會被備份，
        優點是備份時間較快，只有備份異動過的檔案，缺點是資料是不完整的，需要搭配全量備份才可恢復完整資料。

### 如何做備份流程
    備份流程可搭配全量備份和增量備份，取兩個方案各自優點與盡量避免缺點，故可以定期每週做一次全量備份，定期每天或每小時做增量備份，
    這樣當需要使用備份資料時候，只要用上週的全量備份加上各自的增量備份，就可還原到最接近的時間點，而每週一次做全量備份操作，
    是因為可以整合一週內的增量備份，變為一個全量備份，每天或每小時做增量備份，是因為全量備份會影響資料庫較大，使用增量備份就可以減少對資料庫的影響。

## 什麼事恢復
    是用之前備份的檔案，將資料庫恢復到某個時間點的狀態或是恢復到某個資料面的狀態，恢復是可以讓資料庫可以任意回到之前某個狀態的方法，
    但要使用恢復，就必須要保存之前資料庫的檔案，藉由這些檔案才可以選擇恢復到之前那個時間點或那個資料面的狀態，
    藉由恢復擁有還原資料的能力，當資料不正確時，可以恢復到資料正確時的狀態。

### 什麼事基於位置恢復
    mysql 恢復會使用到 binlog 來做增量備份，用 binlog 可以恢復到，最新的正確資料狀態，在執行 binlog 恢復時候，
    可以控制檔案從某個位置開始恢復，到資料錯誤前的上一個位置停止後，再執行跳過資料錯誤語句後，就可以執行後續正確的資料，到最新的位置完成恢復。

### 什麼事基於時間恢復
    一樣使用 binlog 執行恢復流程，除了可以使用位置的條件之外，也可以使用時間點的條件，就可以控制檔案從某個時間點開始恢復，
    到資料錯誤前的上一個時間點停止後，再執行跳過資料錯誤的語句後，就可以繼續執行到最新的時間點，來完成資料正確的恢復。

### 如何做恢復流程
    當發生需要做恢復流程時候，一種情形是有錯誤的資料到資料庫，或是想建立一台新的資料庫，我們如果要來做有錯誤的資料處理狀況，
    首先要先把錯誤資料的表刪除，然後使用完全備份來還原資料庫，再來停止發生資料錯誤前的時間點或是位置，在跳過此錯誤後，開始執行後續還原動作，
    這樣就是一個恢復流程，當要做建立新的資料庫時，跟上述流程雷同，只是不用處理停止在錯誤資料前的動作。

### 如果 mysql Crash，如何恢復
    需要使用 redo log、binlog、undo log，來完成 crash 的恢復，首先會用 checkpoint 找到已寫入 redo log 資料，但尚未寫入 db 的資料，
    會開始從 redo log 依序取得資料後寫入 db 內，此動作是把在 crash 前有 commit 成功，但尚未寫入 db 內的資料，全部同步寫入到 db 內。

    在 commit 階段是分為兩個步驟，先寫入 binlog (用於 slave 同步使用)，再寫入 redo log 內，所以會發生有寫入 binlog 但未寫入 redo log 的資料，
    這樣會發生 slave 有資料，但 master 沒有資料的不一致情況，要避免就需要使用 binlog 和 undo log，因為 undo log 內有 sql 執行前的舊資料，
    所以將 binlog 和 undo log 做比對，當存在 binlog 的資料，就需要寫入 redo log 來完成持久化，而存在 undo log 但不存在 binlog 內的資料，
    就需要回滾資料，代表執行的 sql 語句是失敗的，這樣 master 和 slave 的數據就是一致的。

### Double Write 如何保證數據不丟失
    會需要 Double Write 的情境是，當 db 需要將內存的髒頁，同步到文件的時候，如果此時發生 crash 就會造成數據丟失，
    原因是髒頁默認 16KB 一頁，而文件系統一頁是 4KB，當髒頁同步到文件就需要執行 4次的 IO，當同步到第 2次 IO 發生 crash 的話，
    此時的文件是不完整的頁，是無法使用的，並此情況稱為寫失效，所以為了解決此情況，就需要再執行髒頁前先複製資料到 Double Write buffer 內，
    此時馬上將 Double Write buffer 寫入到 Double Write 文件，再做後續的同步流程，這樣當發生 crash 時候，只需要從 Double Write 文件，
    取得髒頁的副本資料，就可以重新執行髒頁的同步流程。

## 總結
    再備份與恢復流程內，最困難的是在 crash 狀況下，該如何保證數據不丟失，並因為 crash 有可能發生在 commit 流程中，並造成資料流執行是不完全的，
    或是髒頁同步到一半的場景，而 mysql 使用 redo log、binlog、undo log、Double Write 來做到保證。

---
- 備註
  <br/>
  髒頁：當 db 讀取資料過後，會在內存 cache 一份資料，後續修改都是異動內存的資料，當修改內存資料後，就稱為髒頁，意指內存與文件的資料不同步。
  <br/>
  寫失效的英文是 partial page write。

- 參考
  <br/>
  [MySQL 意外宕机不难解决，数据会丢么？但你真的懂数据恢复吗？](https://toutiao.io/posts/dyp1p9/preview)
  <br/>
  [MySQL的undo/redo日志和binlog日志，以及2PC](https://www.cnblogs.com/orange-CC/p/13291960.html)
  <br/>
  [MySQL的Crash Safe和Binlog的关系](https://blog.csdn.net/shaochenshuo/article/details/73239949)
  <br/>
  [MySQL -- 数据恢复](http://zhongmingmao.me/2019/03/04/mysql-data-recovery/)
  <br/>
  [为什么数据不会丢，InnoDB的Double Write，你必须知道](https://juejin.cn/post/6891065928289615879)
  <br/>
  [Mysql InnoDB三大特性-- double write](https://www.shuzhiduo.com/A/lk5aNZBNd1/)
  <br/>
  [innodb_doublewrite_file](https://blog.51cto.com/u_14286115/3331201)
  <br/>
  [MySQL Backup mysqldump備份流程學習](https://www.zendei.com/article/66531.html)
  <br/>
  [mysql 001 | 3種mysql備份恢復方案優劣對比！](https://www.gushiciku.cn/pl/pw9Z/zh-tw)
  <br/>
  [淺談使用Binlog實現MySQL增量備份](https://ppfocus.com/0/dife52662.html)
  <br/>
  [MySQL介紹增量備份與恢復](https://tw511.com/a/01/25911.html)
  <br/>
  [MySQL Backup mysqldump 常用选项与主要用法](https://www.cnblogs.com/dbabd/p/10232786.html)
  <br/>
  [MySQL資料庫的熱備份和冷備份優缺點](https://www.itread01.com/content/1549841955.html)
  <br/>
  [資料庫應用——MySQL的全量、增量備份與恢復](https://www.uj5u.com/qita/275755.html)
  <br/>
  [MySQL——全量，增量备份与恢复（理论篇](https://blog.51cto.com/u_14080162/2453854)
  <br/>
  [MySQL備份與恢復操作解析](https://iter01.com/574690.html)
  